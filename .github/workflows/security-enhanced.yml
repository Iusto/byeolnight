name: ê°•í™”ëœ ë³´ì•ˆ ê²€ì‚¬

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ

jobs:
  security-audit:
    name: ì¢…í•© ë³´ì•ˆ ê°ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
      run: chmod +x ./gradlew

    # ë°±ì—”ë“œ ë³´ì•ˆ ê²€ì‚¬
    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬
      run: |
        ./gradlew dependencyCheckAnalyze --info
        if [ -f "build/reports/dependency-check-report.html" ]; then
          echo "âœ… ì˜ì¡´ì„± ê²€ì‚¬ ì™„ë£Œ"
        else
          echo "âš ï¸ ì˜ì¡´ì„± ê²€ì‚¬ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨"
        fi

    # í”„ë¡ íŠ¸ì—”ë“œ ë³´ì•ˆ ê²€ì‚¬
    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./byeolnight-frontend
      run: |
        rm -rf node_modules package-lock.json
        npm install --no-audit

    - name: í”„ë¡ íŠ¸ì—”ë“œ ì·¨ì•½ì  ê²€ì‚¬
      working-directory: ./byeolnight-frontend
      run: |
        echo "ğŸ” npm audit ì‹¤í–‰ ì¤‘..."
        npm audit --audit-level=moderate --json > audit-report.json || true
        
        # ì‹¬ê°í•œ ì·¨ì•½ì ë§Œ ì²´í¬
        CRITICAL=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
        
        echo "ğŸ” ë°œê²¬ëœ ì·¨ì•½ì :"
        echo "  - Critical: $CRITICAL"
        echo "  - High: $HIGH"
        
        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 5 ]; then
          echo "âŒ ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          npm audit fix --force || true
          echo "ğŸ”§ ìë™ ìˆ˜ì • ì‹œë„ ì™„ë£Œ"
        else
          echo "âœ… í—ˆìš© ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ ì·¨ì•½ì ì…ë‹ˆë‹¤."
        fi

    # CodeQL ë¶„ì„
    - name: CodeQL ì´ˆê¸°í™”
      uses: github/codeql-action/init@v3
      with:
        languages: java, javascript
        queries: security-and-quality

    - name: ë°±ì—”ë“œ ë¹Œë“œ (ë³´ì•ˆ ê²€ì‚¬ìš©)
      run: ./gradlew build -x test --no-daemon

    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ë³´ì•ˆ ê²€ì‚¬ìš©)
      working-directory: ./byeolnight-frontend
      run: npm run build

    - name: CodeQL ë¶„ì„ ì‹¤í–‰
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:java,javascript"

    # ë³´ê³ ì„œ ì—…ë¡œë“œ
    - name: ë³´ì•ˆ ê²€ì‚¬ ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          build/reports/dependency-check-report.*
          byeolnight-frontend/audit-report.json
        retention-days: 30