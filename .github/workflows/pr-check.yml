name: PR ê²€ì¦

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR ìœ íš¨ì„± ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

    - name: ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
      id: changed-files
      uses: tj-actions/changed-files@v42
      with:
        files_yaml: |
          backend:
            - 'src/**'
            - 'build.gradle'
            - 'Dockerfile'
          frontend:
            - 'byeolnight-frontend/**'
          docs:
            - 'docs/**'
            - '*.md'
          config:
            - 'docker-compose*.yml'
            - '.github/**'

    - name: ë³€ê²½ ì‚¬í•­ ìš”ì•½
      run: |
        echo "## ðŸ“Š ë³€ê²½ ì‚¬í•­ ë¶„ì„" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ]]; then
          echo "ðŸ”§ **ë°±ì—”ë“œ ë³€ê²½**: ${{ steps.changed-files.outputs.backend_all_changed_files }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]]; then
          echo "ðŸŽ¨ **í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½**: ${{ steps.changed-files.outputs.frontend_all_changed_files }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]]; then
          echo "ðŸ“š **ë¬¸ì„œ ë³€ê²½**: ${{ steps.changed-files.outputs.docs_all_changed_files }}" >> $GITHUB_STEP_SUMMARY
        fi

  size-check:
    name: PR í¬ê¸° ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: PR í¬ê¸° ë¶„ì„
      run: |
        # ë³€ê²½ëœ ë¼ì¸ ìˆ˜ ê³„ì‚°
        CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | grep -o '[0-9]\+ insertions\|[0-9]\+ deletions' | grep -o '[0-9]\+' | paste -sd+ | bc)
        
        echo "ë³€ê²½ëœ ë¼ì¸ ìˆ˜: $CHANGED_LINES"
        
        # 500ë¼ì¸ ì´ìƒ ë³€ê²½ ì‹œ ê²½ê³ 
        if [ "$CHANGED_LINES" -gt 500 ]; then
          echo "âš ï¸ ì´ PRì€ 500ë¼ì¸ ì´ìƒ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤ ($CHANGED_LINES ë¼ì¸)"
          echo "ë” ìž‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”."
          echo "::warning::Large PR detected ($CHANGED_LINES lines changed)"
        else
          echo "âœ… ì ì ˆí•œ í¬ê¸°ì˜ PRìž…ë‹ˆë‹¤ ($CHANGED_LINES ë¼ì¸)"
        fi

  auto-assign:
    name: ìžë™ ë¦¬ë·°ì–´ í• ë‹¹
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: ë¦¬ë·°ì–´ ìžë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          // í˜„ìž¬ ë¦¬í¬ì§€í† ë¦¬ì— ë¦¬ë·°ì–´ê°€ ì„¤ì •ë˜ì–´ ìžˆì§€ ì•Šìœ¼ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
          console.log('í˜„ìž¬ ë¦¬í¬ì§€í† ë¦¬ì— ë¦¬ë·°ì–´ê°€ ì„¤ì •ë˜ì–´ ìžˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
          console.log('PR ìž‘ì„±ìž:', context.payload.pull_request.user.login);
          
          // ë¦¬ë·°ì–´ ì„¤ì •ì´ í•„ìš”í•œ ê²½ìš° ì•„ëž˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:
          /*
          const reviewers = ['actual-github-username']; // ì‹¤ì œ GitHub ì‚¬ìš©ìžëª…ìœ¼ë¡œ ë³€ê²½
          const author = context.payload.pull_request.user.login;
          const availableReviewers = reviewers.filter(reviewer => reviewer !== author);
          
          if (availableReviewers.length > 0) {
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              reviewers: availableReviewers.slice(0, 2)
            });
          }
          */