name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  security-scan:
    name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: CodeQL ì´ˆê¸°í™”
      uses: github/codeql-action/init@v3
      with:
        languages: java, javascript

    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
      run: chmod +x ./gradlew

    - name: ë°±ì—”ë“œ ë¹Œë“œ
      env:
        GRADLE_OPTS: "-Xmx1g -XX:MaxMetaspaceSize=256m"
      run: ./gradlew compileJava --no-daemon

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./byeolnight-frontend
      run: npm install --legacy-peer-deps
        
    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      working-directory: ./byeolnight-frontend
      run: npm run build

    - name: CodeQL ë¶„ì„ ì‹¤í–‰
      uses: github/codeql-action/analyze@v3
      env:
        CODEQL_EXTRACTOR_JAVA_HEAP_SIZE: 1024

  dependency-check:
    name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
      run: chmod +x ./gradlew

    - name: Gradle ë¹Œë“œ ê²€ì¦
      env:
        GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=512m"
      run: |
        echo "ğŸ” Gradle ë¹Œë“œ ê²€ì¦ ì¤‘..."
        ./gradlew build -x test --no-daemon
        echo "âœ… Gradle ë¹Œë“œ ì™„ë£Œ"

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./byeolnight-frontend
      run: npm install --legacy-peer-deps
        
    - name: npm audit ì‹¤í–‰
      working-directory: ./byeolnight-frontend
      run: |
        npm audit --audit-level=moderate || {
          echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ ìˆ˜ì •ì„ ì‹œë„í•©ë‹ˆë‹¤..."
          npm audit fix --force || echo "âš ï¸ ì¼ë¶€ ì·¨ì•½ì ì€ ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
        }