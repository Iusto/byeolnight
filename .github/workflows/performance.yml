name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

on:
  schedule:
    - cron: '0 6 * * 1'   # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤í›„ 3ì‹œ (UTC 06:00 = KST 15:00)
  workflow_dispatch:     # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ master ]
    paths: [ '.github/workflows/performance.yml' ]
    inputs:
      target_url:
        description: 'í…ŒìŠ¤íŠ¸í•  URL'
        required: true
        default: 'http://localhost:8080'
      duration:
        description: 'í…ŒìŠ¤íŠ¸ ì§€ì† ì‹œê°„ (ì´ˆ)'
        required: true
        default: '60'

jobs:
  load-test:
    name: ë¶€í•˜ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: byeolnight_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: MySQL ì—°ê²° ëŒ€ê¸°
      run: |
        echo "MySQL ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘..."
        for i in {1..30}; do
          if MYSQL_PWD=test mysqladmin ping -h 127.0.0.1 -P 3306 -u root --silent; then
            echo "âœ… MySQL ì—°ê²° ì„±ê³µ"
            break
          fi
          echo "ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 2
        done

    - name: ë°±ì—”ë“œ ì„œë²„ ì‹œì‘
      run: |
        chmod +x ./gradlew
        nohup ./gradlew bootRun --args='--spring.profiles.active=test' > server.log 2>&1 &
        echo $! > server.pid
        echo "ì„œë²„ PID: $(cat server.pid)"
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/byeolnight_test
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: test
        SPRING_DATA_REDIS_HOST: localhost
        SPRING_DATA_REDIS_PORT: 6379
        JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}

    - name: ì„œë²„ ì‹œì‘ ëŒ€ê¸°
      run: |
        echo "ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
        for i in {1..60}; do
          if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
            echo "âœ… ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
            break
          elif [ $i -eq 30 ]; then
            echo "âš ï¸ ì„œë²„ ë¡œê·¸ í™•ì¸:"
            tail -20 server.log || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
          fi
          echo "ëŒ€ê¸° ì¤‘... ($i/60)"
          sleep 5
        done
        
        if ! curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
          echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨ - ë¡œê·¸ ì¶œë ¥:"
          cat server.log || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
          exit 1
        fi

    - name: K6 ì„¤ì¹˜
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        cat > load-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        import { Rate } from 'k6/metrics';

        export let errorRate = new Rate('errors');

        export let options = {
          stages: [
            { duration: '30s', target: 10 },  // 30ì´ˆê°„ 10ëª…ê¹Œì§€ ì¦ê°€
            { duration: '1m', target: 10 },   // 1ë¶„ê°„ 10ëª… ìœ ì§€
            { duration: '30s', target: 20 },  // 30ì´ˆê°„ 20ëª…ê¹Œì§€ ì¦ê°€
            { duration: '1m', target: 20 },   // 1ë¶„ê°„ 20ëª… ìœ ì§€
            { duration: '30s', target: 0 },   // 30ì´ˆê°„ 0ëª…ê¹Œì§€ ê°ì†Œ
          ],
          thresholds: {
            http_req_duration: ['p(95)<500'],  // 95%ì˜ ìš”ì²­ì´ 500ms ì´í•˜
            errors: ['rate<0.1'],              // ì—ëŸ¬ìœ¨ 10% ì´í•˜
          },
        };

        const BASE_URL = __ENV.TARGET_URL || 'http://localhost:8080';

        export default function() {
          // 1. í—¬ìŠ¤ì²´í¬ API
          let response = http.get(`${BASE_URL}/actuator/health`);
          check(response, {
            'health status is 200': (r) => r.status === 200,
            'health response time < 200ms': (r) => r.timings.duration < 200,
          }) || errorRate.add(1);

          // 2. ê²Œì‹œê¸€ ëª©ë¡ API
          response = http.get(`${BASE_URL}/api/posts?page=0&size=10`);
          check(response, {
            'posts status is 200': (r) => r.status === 200,
            'posts response time < 500ms': (r) => r.timings.duration < 500,
          }) || errorRate.add(1);

          // 3. ê²Œì‹œê¸€ ìƒì„¸ API (ID=1 ê°€ì •)
          response = http.get(`${BASE_URL}/api/posts/1`);
          check(response, {
            'post detail status is 200 or 404': (r) => r.status === 200 || r.status === 404,
            'post detail response time < 300ms': (r) => r.timings.duration < 300,
          }) || errorRate.add(1);

          // 4. ëŒ“ê¸€ ëª©ë¡ API
          response = http.get(`${BASE_URL}/api/posts/1/comments`);
          check(response, {
            'comments status is 200 or 404': (r) => r.status === 200 || r.status === 404,
            'comments response time < 400ms': (r) => r.timings.duration < 400,
          }) || errorRate.add(1);

          // 5. ì¹´í…Œê³ ë¦¬ë³„ ê²Œì‹œê¸€ API
          response = http.get(`${BASE_URL}/api/posts?category=FREE&page=0&size=5`);
          check(response, {
            'category posts status is 200': (r) => r.status === 200,
            'category posts response time < 500ms': (r) => r.timings.duration < 500,
          }) || errorRate.add(1);

          // 6. ê²€ìƒ‰ API
          response = http.get(`${BASE_URL}/api/posts/search?keyword=test&page=0&size=5`);
          check(response, {
            'search status is 200': (r) => r.status === 200,
            'search response time < 600ms': (r) => r.timings.duration < 600,
          }) || errorRate.add(1);

          // 7. ì¸ê¸° ê²Œì‹œê¸€ API
          response = http.get(`${BASE_URL}/api/posts/popular?page=0&size=5`);
          check(response, {
            'popular posts status is 200': (r) => r.status === 200,
            'popular posts response time < 500ms': (r) => r.timings.duration < 500,
          }) || errorRate.add(1);

          // 8. ìŠ¤í…”ë¼ ìƒì  API
          response = http.get(`${BASE_URL}/api/shop/items`);
          check(response, {
            'shop items status is 200': (r) => r.status === 200,
            'shop items response time < 400ms': (r) => r.timings.duration < 400,
          }) || errorRate.add(1);

          sleep(1);
        }
        EOF

    - name: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        TARGET_URL="${{ github.event.inputs.target_url || 'http://localhost:8080' }}"
        echo "ğŸ¯ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ URL: $TARGET_URL"
        k6 run --env TARGET_URL="$TARGET_URL" load-test.js

    - name: ì„œë²„ ì¢…ë£Œ
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi

    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          *.json
          *.html

  lighthouse:
    name: Lighthouse ì„±ëŠ¥ ì¸¡ì •
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: pnpm ì„¤ì¹˜
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'byeolnight-frontend/pnpm-lock.yaml'

    - name: í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd byeolnight-frontend
        pnpm install

    - name: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ì„œë²„ ì‹œì‘
      run: |
        cd byeolnight-frontend
        pnpm run build
        pnpm run preview &
        echo $! > ../frontend.pid

    - name: í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ëŒ€ê¸°
      run: |
        echo "í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
        for i in {1..20}; do
          if curl -f http://localhost:4173 > /dev/null 2>&1; then
            echo "í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
            break
          fi
          echo "ëŒ€ê¸° ì¤‘... ($i/20)"
          sleep 3
        done

    - name: Lighthouse CI ì‹¤í–‰
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          http://localhost:4173
        configPath: './.lighthouserc.json'
        uploadArtifacts: false
        temporaryPublicStorage: true
      continue-on-error: true

    - name: í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì¢…ë£Œ
      if: always()
      run: |
        if [ -f frontend.pid ]; then
          kill $(cat frontend.pid) || true
          rm frontend.pid
        fi

  database-performance:
    name: ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: byeolnight_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
      run: chmod +x ./gradlew

    - name: MySQL ì—°ê²° ëŒ€ê¸° ë° í…ŒìŠ¤íŠ¸
      run: |
        echo "MySQL ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘..."
        for i in {1..30}; do
          if MYSQL_PWD=test mysqladmin ping -h 127.0.0.1 -P 3306 -u root --silent; then
            echo "âœ… MySQL ì—°ê²° ì„±ê³µ"
            break
          fi
          echo "ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 3
        done
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° ê¸°ë³¸ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
        MYSQL_PWD=test mysql -h 127.0.0.1 -P 3306 -u root -e "SELECT 1 as test_connection;" byeolnight_test
        MYSQL_PWD=test mysql -h 127.0.0.1 -P 3306 -u root -e "SHOW TABLES;" byeolnight_test
        echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"