name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

on:
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ
  workflow_dispatch:     # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      target_url:
        description: 'í…ŒìŠ¤íŠ¸í•  URL'
        required: true
        default: 'http://localhost:8080'
      duration:
        description: 'í…ŒìŠ¤íŠ¸ ì§€ì† ì‹œê°„ (ì´ˆ)'
        required: true
        default: '60'

jobs:
  load-test:
    name: ë¶€í•˜ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: K6 ì„¤ì¹˜
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        cat > load-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        import { Rate } from 'k6/metrics';

        export let errorRate = new Rate('errors');

        export let options = {
          stages: [
            { duration: '2m', target: 10 },   // 2ë¶„ê°„ 10ëª…ê¹Œì§€ ì¦ê°€
            { duration: '5m', target: 10 },   // 5ë¶„ê°„ 10ëª… ìœ ì§€
            { duration: '2m', target: 20 },   // 2ë¶„ê°„ 20ëª…ê¹Œì§€ ì¦ê°€
            { duration: '5m', target: 20 },   // 5ë¶„ê°„ 20ëª… ìœ ì§€
            { duration: '2m', target: 0 },    // 2ë¶„ê°„ 0ëª…ê¹Œì§€ ê°ì†Œ
          ],
          thresholds: {
            http_req_duration: ['p(95)<500'],  // 95%ì˜ ìš”ì²­ì´ 500ms ì´í•˜
            errors: ['rate<0.1'],              // ì—ëŸ¬ìœ¨ 10% ì´í•˜
          },
        };

        const BASE_URL = __ENV.TARGET_URL || 'http://localhost:8080';

        export default function() {
          // ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          let response = http.get(`${BASE_URL}/api/health`);
          check(response, {
            'status is 200': (r) => r.status === 200,
            'response time < 500ms': (r) => r.timings.duration < 500,
          }) || errorRate.add(1);

          // ê²Œì‹œê¸€ ëª©ë¡ API í…ŒìŠ¤íŠ¸
          response = http.get(`${BASE_URL}/api/posts?page=0&size=10`);
          check(response, {
            'posts API status is 200': (r) => r.status === 200,
          }) || errorRate.add(1);

          sleep(1);
        }
        EOF

    - name: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        TARGET_URL="${{ github.event.inputs.target_url || 'http://localhost:8080' }}"
        echo "ğŸ¯ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ URL: $TARGET_URL"
        k6 run --env TARGET_URL="$TARGET_URL" load-test.js

    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          *.json
          *.html

  lighthouse:
    name: Lighthouse ì„±ëŠ¥ ì¸¡ì •
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Lighthouse CI ì‹¤í–‰
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ github.event.inputs.target_url || 'http://localhost:8080' }}
        configPath: './.lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

  database-performance:
    name: ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: byeolnight_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
      run: chmod +x ./gradlew

    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        # ì‹¤ì œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ëŠ” ë³„ë„ í”„ë¡œíŒŒì¼ë¡œ ì‹¤í–‰
        ./gradlew test --tests "*PerformanceTest" -Dspring.profiles.active=performance
      env:
        DB_HOST: localhost
        DB_PORT: 3306
        DB_NAME: byeolnight_test
        DB_USERNAME: root
        DB_PASSWORD: test